<!DOCTYPE html>

<html>
<head>
  <title>chap08.spec.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>chap08.spec.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

<span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'expect.js'</span>);


<span class="hljs-keyword">var</span> match = (exp, pattern) =&gt; {
  <span class="hljs-keyword">return</span> exp.call(pattern, pattern);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="-">関数型言語を作る</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>describe(<span class="hljs-string">'関数型言語を作る'</span>, () =&gt; {
  describe(<span class="hljs-string">'環境を作る'</span>, () =&gt; {
    <span class="hljs-comment">/* #@range_begin(environment) */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="-">環境</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> emptyEnv = (variable) =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    };
    <span class="hljs-comment">/* 変数名に対応する値を環境から取りだす */</span>
    <span class="hljs-keyword">var</span> lookupEnv = (identifier, env) =&gt; {
      <span class="hljs-keyword">return</span> env(identifier);
    };
    <span class="hljs-comment">/* 環境を拡張する */</span>
    <span class="hljs-keyword">var</span> extendEnv = (identifier, value, env) =&gt; {
      expect(identifier).to.a(<span class="hljs-string">'string'</span>);
      <span class="hljs-keyword">return</span> (queryIdentifier) =&gt; {
        expect(queryIdentifier).to.a(<span class="hljs-string">'string'</span>);
        <span class="hljs-keyword">if</span>(identifier === queryIdentifier) {
          <span class="hljs-keyword">return</span> value;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> lookupEnv(queryIdentifier,env);
        }
      };
    };
    <span class="hljs-comment">/* #@range_end(environment) */</span>
    describe(<span class="hljs-string">'環境をテストする'</span>, () =&gt; {
      it(<span class="hljs-string">'extendEnvで環境を作り、 lookupEnv で環境を探る'</span>, (next) =&gt; {
        <span class="hljs-keyword">var</span> newEnv = extendEnv(<span class="hljs-string">'a'</span>,<span class="hljs-number">1</span>, emptyEnv);
        expect(
          lookupEnv(<span class="hljs-string">"a"</span>, newEnv)
        ).to.be(
          <span class="hljs-number">1</span>
        );
        next();
      });
    });
    describe(<span class="hljs-string">'式を作る'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="-">式の代数的データ構造</h2>
<p>var match = (exp, pattern) =&gt; {
  return exp.call(pattern, pattern);
};</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-comment">/* #@range_begin(expression_algaraic_datatype) */</span>
      <span class="hljs-keyword">var</span> number = (value) =&gt; {
        expect(value).to.a(<span class="hljs-string">'number'</span>);
        <span class="hljs-keyword">return</span> (pattern) =&gt; {
          <span class="hljs-keyword">return</span> pattern.number(value);
        };
      };
      <span class="hljs-keyword">var</span> variable = (name) =&gt; {
        expect(name).to.a(<span class="hljs-string">'string'</span>);
        <span class="hljs-keyword">return</span> (pattern) =&gt; {
          <span class="hljs-keyword">return</span> pattern.variable(name);
        };
      };
      <span class="hljs-keyword">var</span> lambda = (variable, body) =&gt; {
        expect(variable).to.a(<span class="hljs-string">'function'</span>);
        expect(body).to.a(<span class="hljs-string">'function'</span>);
        <span class="hljs-keyword">return</span> (pattern) =&gt; {
          <span class="hljs-keyword">return</span> pattern.lambda(variable, body);
        };
      };
      <span class="hljs-keyword">var</span> application = (variable, arg) =&gt; {
        <span class="hljs-keyword">return</span> (pattern) =&gt; {
          <span class="hljs-keyword">return</span> pattern.application(variable, arg);
        };
      };
      it(<span class="hljs-string">'式をテストする'</span>, (next) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>λx.λy.x</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        match(lambda(variable(<span class="hljs-string">"x"</span>),lambda(variable(<span class="hljs-string">"y"</span>),variable(<span class="hljs-string">"x"</span>))),{
          lambda: (variable, arg) =&gt; {
            expect(
              variable
            ).to.a(<span class="hljs-string">'function'</span>);
          }
        });
        next();
      });
      <span class="hljs-comment">/* #@range_end(expression_algaraic_datatype) */</span>
      describe(<span class="hljs-string">'評価器を作る'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="-">式の評価関数</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-comment">/* #@range_begin(evaluation_function) */</span>
        <span class="hljs-keyword">var</span> evaluate = (exp, env) =&gt; {
          <span class="hljs-keyword">return</span> match(exp,{
            <span class="hljs-comment">/* 数値の評価 */</span>
            number: (value) =&gt; {
              <span class="hljs-keyword">return</span> value;
            },
            <span class="hljs-comment">/* 変数の評価 */</span>
            variable: (name) =&gt; {
              <span class="hljs-keyword">return</span> lookupEnv(name, env);
            },
            <span class="hljs-comment">/* λ式の評価 */</span>
            lambda: (variable, bodyExp) =&gt; {
              <span class="hljs-comment">/* クロージャーを返す */</span>
              <span class="hljs-keyword">return</span> (actualArg) =&gt; {
                <span class="hljs-keyword">return</span> match(variable,{ <span class="hljs-comment">// maybeを返すべきか？</span>
                  variable: (name) =&gt; {
                    <span class="hljs-keyword">return</span> evaluate(bodyExp, extendEnv(name, actualArg ,env));
                  }
                });
              };
            },
            <span class="hljs-comment">/* 関数適用の評価 */</span>
            application: (variable, arg) =&gt; {
              <span class="hljs-keyword">var</span> rator = evaluate(variable, env);
              <span class="hljs-keyword">var</span> rand = evaluate(arg, env);
              <span class="hljs-keyword">return</span> rator(rand);
            }
          });
        };
        <span class="hljs-comment">/* #@range_end(evaluation_function) */</span>
        describe(<span class="hljs-string">'evaluate関数で式を評価する'</span>, () =&gt; {
          it(<span class="hljs-string">'数値を評価する'</span>, (next) =&gt; {
            expect(
              evaluate(number(<span class="hljs-number">2</span>), emptyEnv)
            ).to.be(
              <span class="hljs-number">2</span>
            );
            next();
          });
          it(<span class="hljs-string">'変数を評価する'</span>, (next) =&gt; {
            <span class="hljs-keyword">var</span> env = extendEnv(<span class="hljs-string">"x"</span>,<span class="hljs-number">1</span>, emptyEnv);
            expect(
              evaluate(variable(<span class="hljs-string">"x"</span>), env)
            ).to.be(
              <span class="hljs-number">1</span>
            );
            expect(
              evaluate(variable(<span class="hljs-string">"y"</span>), env)
            ).to.be(
              <span class="hljs-literal">undefined</span>
            );
            next();
          });
          it(<span class="hljs-string">'constant関数'</span>, (next) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>λx.1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> constant = lambda(variable(<span class="hljs-string">"x"</span>),number(<span class="hljs-number">1</span>));
            expect(
              evaluate(constant, emptyEnv)
            ).to.a(
              <span class="hljs-string">'function'</span>
            );
            <span class="hljs-keyword">var</span> applied = application(constant, variable(<span class="hljs-string">"y"</span>));
            expect(
              evaluate(applied, emptyEnv)
            ).to.eql(
              <span class="hljs-number">1</span>
            );
            next();
          });
          it(<span class="hljs-string">'identity関数'</span>, (next) =&gt; {
            <span class="hljs-comment">/* λx.x */</span>
            <span class="hljs-keyword">var</span> identity = lambda(variable(<span class="hljs-string">"x"</span>),variable(<span class="hljs-string">"x"</span>));
            expect(
              evaluate(identity, emptyEnv)
            ).to.a(
              <span class="hljs-string">'function'</span>
            );
            expect(
              evaluate(application(identity, number(<span class="hljs-number">1</span>)), emptyEnv)
            ).to.eql(
              <span class="hljs-number">1</span>
            );
            next();
          });
          it(<span class="hljs-string">'ブール型を評価する'</span>, (next) =&gt; {
            <span class="hljs-comment">/* λx.λy.x */</span>
            <span class="hljs-keyword">var</span> trueFun = lambda(variable(<span class="hljs-string">"x"</span>),lambda(variable(<span class="hljs-string">"y"</span>),variable(<span class="hljs-string">"x"</span>)));
            <span class="hljs-comment">/* λx.λy.y */</span>
            <span class="hljs-keyword">var</span> falseFun = lambda(variable(<span class="hljs-string">"x"</span>),lambda(variable(<span class="hljs-string">"y"</span>),variable(<span class="hljs-string">"y"</span>)));
            <span class="hljs-keyword">var</span> not = lambda(variable(<span class="hljs-string">"x"</span>),
                             application(
                               application(
                                 variable(<span class="hljs-string">"x"</span>),falseFun),
                               trueFun));
            <span class="hljs-keyword">var</span> and = lambda(variable(<span class="hljs-string">"x"</span>),
                             lambda(variable(<span class="hljs-string">"y"</span>),
                                    application(
                                      application(variable(<span class="hljs-string">"x"</span>),variable(<span class="hljs-string">"y"</span>)),
                                      falseFun)));
            <span class="hljs-keyword">var</span> or = lambda(variable(<span class="hljs-string">"x"</span>),
                            lambda(variable(<span class="hljs-string">"y"</span>),
                                   application(
                                     application(variable(<span class="hljs-string">"x"</span>),trueFun),
                                     variable(<span class="hljs-string">"y"</span>))));
            <span class="hljs-keyword">var</span> cond = lambda(variable(<span class="hljs-string">"pred"</span>),
                              lambda(variable(<span class="hljs-string">"x"</span>),
                                     lambda(variable(<span class="hljs-string">"y"</span>),
                                            application(
                                              application(variable(<span class="hljs-string">"pred"</span>),variable(<span class="hljs-string">"x"</span>)),variable(<span class="hljs-string">"y"</span>)))));
            expect(
              evaluate(
                application(
                  application(trueFun,number(<span class="hljs-number">1</span>)),
                  number(<span class="hljs-number">0</span>)),
                emptyEnv)
            ).to.eql(
              <span class="hljs-number">1</span>
            );
            expect(
              evaluate(
                application(
                  application(
                    application(not, trueFun), number(<span class="hljs-number">1</span>)), number(<span class="hljs-number">0</span>)),emptyEnv)
            ).to.eql(
              <span class="hljs-number">0</span>
            );
            expect(
              evaluate(
                application(
                  application(
                    application(
                      application(and,
                                  trueFun),
                      trueFun),
                    number(<span class="hljs-number">1</span>)),
                  number(<span class="hljs-number">0</span>)),emptyEnv)
            ).to.be(
              <span class="hljs-number">1</span>
            );
            expect(
              evaluate(
                application(
                  application(
                    application(
                      application(
                        application(cond, trueFun),
                        falseFun),
                      trueFun),
                    number(<span class="hljs-number">1</span>)),
                  number(<span class="hljs-number">0</span>)),
                emptyEnv)
            ).to.eql(
              <span class="hljs-number">0</span>
            );
            next();
          });
        });
      });
    }); <span class="hljs-comment">// </span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>describe(‘式と値を分離した評価器’, () =&gt; {
  // ## 式の代数的データ構造
  var exp = {
    number: (value) =&gt; {
      expect(value).to.a(‘number’);
      return (pattern) =&gt; {
        return pattern.number(value);
      };
    },
    variable: (name) =&gt; {
      expect(name).to.a(‘string’);
      return (pattern) =&gt; {
        return pattern.variable(name);
      };
    },
    lambda: (variable, body) =&gt; {
      expect(variable).to.a(‘function’);
      expect(body).to.a(‘function’);
      return (pattern) =&gt; {
        return pattern.lambda(variable, body);
      };
    },
    application: (variable, arg) =&gt; {
      return (pattern) =&gt; {
        return pattern.application(variable, arg);
      };
    }
  }; // exp
  // RESULT
  var result = {
    value: (answer) =&gt; {
      return (pattern) =&gt; {
        return pattern.value(answer);
      };
    },
    // closure: (func) =&gt; {
    //   return (pattern) =&gt; {
    //  return pattern.closure(func);
    //   };
    // }
  };
  var evaluate = (exp, env) =&gt; {
    return match(exp,{
      /<em> 数値の評価 </em>/
      number: (value) =&gt; {
        return result.value(value);
      },
      /<em> 変数の評価 </em>/
      variable: (name) =&gt; {
        return result.value(lookupEnv(name, env));
      },
      /<em> λ式の評価 </em>/
      lambda: (variable, bodyExp) =&gt; {
        /<em> クロージャーを返す </em>/
        return result.value((actualArg) =&gt; {
          return match(variable,{
            variable: (name) =&gt; {
              return match(evaluate(bodyExp, extendEnv(name, actualArg ,env)),{
                value: (value) =&gt; {
                  return value;
                }
              });
            }
          });
        });
      },
      /<em> 関数適用の評価 </em>/
      application: (func, arg) =&gt; {
        return match(evaluate(func, env),{
          value: (closure) =&gt; {
            var rand = evaluate(arg, env);
            return closure(rand);
          }
        });
      }
    });
  };
  it(‘数値を評価する’, (next) =&gt; {
    match(evaluate(exp.number(2), emptyEnv), {
      value: (answer) =&gt; {
        expect(answer).to.eql(2);
      },
      abort: (message) =&gt; {
        expect().fail();
      }
    });
    next();
  });
  it(‘変数を評価する’, (next) =&gt; {
    var env = extendEnv(“x”,1, emptyEnv);
      match(evaluate(exp.variable(“x”), env), {
        value: (answer) =&gt; {
          expect(answer).to.eql(1);
        }
      });
      // 自由変数の場合
      match(evaluate(exp.variable(“y”), env), {
        value: (answer) =&gt; {
          expect(answer).to.eql(undefined);
        }
      });
    next();
  });
  it(‘constant関数’, (next) =&gt; {
    // λx.1
    var constant = exp.lambda(exp.variable(“x”),exp.number(1));
    expect(
      evaluate(constant, emptyEnv)
    ).to.a(
      ‘function’
    );
    // (λx.1)(2)
    var appliedExpression = exp.application(constant, exp.number(2));
      match(evaluate(appliedExpression, emptyEnv), {
        value: (answer) =&gt; {
          expect(answer).to.eql(undefined);
        }
      });
    next();
  });
}); // 式と値を分離した評価器</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    describe(<span class="hljs-string">'継続渡し評価器'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="-">式の代数的データ構造</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> exp = {
        raise: (exp) =&gt; {
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.raise(exp);
          };
        },
        number: (value) =&gt; {
          expect(value).to.a(<span class="hljs-string">'number'</span>);
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.number(value);
          };
        },
        variable: (name) =&gt; {
          expect(name).to.a(<span class="hljs-string">'string'</span>);
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.variable(name);
          };
        },
        lambda: (variable, body) =&gt; {
          expect(variable).to.a(<span class="hljs-string">'function'</span>);
          expect(body).to.a(<span class="hljs-string">'function'</span>);
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.lambda(variable, body);
          };
        },
        application: (variable, arg) =&gt; {
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.application(variable, arg);
          };
        }
      }; <span class="hljs-comment">// exp</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="-">式の評価関数</h2>
<p>evaluateCPS: (EXP, ENV, FUNC[VALUE -&gt; VALUE]) -&gt; VALUE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> evaluateCPS = (exp, env, continues) =&gt; {
        <span class="hljs-keyword">return</span> match(exp,{
          <span class="hljs-comment">/* 例外の評価 */</span>
          raise: (message) =&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message);
          },
          <span class="hljs-comment">/* 数値の評価 */</span>
          number: (answer) =&gt; {
            <span class="hljs-keyword">return</span> continues(answer);
          },
          <span class="hljs-comment">/* 変数の評価 */</span>
          variable: (name) =&gt; {
            <span class="hljs-keyword">var</span> found = lookupEnv(name, env);
            <span class="hljs-keyword">if</span>(found === <span class="hljs-literal">undefined</span>){
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(name + <span class="hljs-string">" not found"</span>);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">return</span> continues(found);
            }
          },
          <span class="hljs-comment">/* λ式の評価 */</span>
          lambda: (exp, bodyExp) =&gt; {
            <span class="hljs-comment">/* クロージャーを返す */</span>
            <span class="hljs-keyword">return</span> (actualArg) =&gt; {
              <span class="hljs-keyword">return</span> match(exp,{
                variable: (name) =&gt; {
                  <span class="hljs-keyword">return</span> continues(evaluateCPS(bodyExp, extendEnv(name, actualArg ,env), continues));
                },
                number: (value) =&gt; {
                  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数が数値になっています"</span>);
                },
                lambda: ($$,$$$) =&gt; {
                  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数がlambbaになっています"</span>);
                }
              });
            };
          },
          <span class="hljs-comment">/* 関数適用の評価 */</span>
          application: (exp, arg) =&gt; {
            <span class="hljs-keyword">var</span> rator = evaluateCPS(exp, env, continues);
            <span class="hljs-keyword">var</span> rand = evaluateCPS(arg, env, continues);
            <span class="hljs-keyword">return</span> continues(rator(rand));
          }
        });
	  };
	  describe(<span class="hljs-string">'継続渡し評価器をテストする'</span>, () =&gt; {
	  	<span class="hljs-keyword">var</span> returns = (result) =&gt; {
	  	  <span class="hljs-keyword">return</span> result;
	  	};
        it(<span class="hljs-string">'数値を評価する'</span>, (next) =&gt; {
          expect(
            evaluateCPS(exp.number(<span class="hljs-number">2</span>), emptyEnv, returns)
          ).to.eql(<span class="hljs-number">2</span>);
	  	  next();
        });
        it(<span class="hljs-string">'変数を評価する'</span>, (next) =&gt; {
          <span class="hljs-keyword">var</span> env = extendEnv(<span class="hljs-string">"x"</span>,<span class="hljs-number">1</span>, emptyEnv, returns);
	  	  expect(
            evaluateCPS(exp.variable(<span class="hljs-string">"x"</span>), env, returns)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>自由変数の場合は、 abortが返る</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  	  expect(
            evaluateCPS(exp.variable(<span class="hljs-string">"y"</span>), env, returns)
          ).to.eql(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"y not found"</span>)
          );
          next();
        });
        it(<span class="hljs-string">'constant関数'</span>, (next) =&gt; {
          <span class="hljs-keyword">var</span> constant = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.number(<span class="hljs-number">1</span>));
          expect(
            evaluateCPS(constant, emptyEnv, returns)
          ).to.a(
            <span class="hljs-string">'function'</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>(λx.1)(2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> applied = exp.application(constant, exp.number(<span class="hljs-number">2</span>));
	  	  expect(
            evaluateCPS(applied, emptyEnv, returns)
          ).to.eql(
            <span class="hljs-number">1</span>
          );
          next();
        });
        it(<span class="hljs-string">'identity関数をテストする'</span>, (next) =&gt; {
          <span class="hljs-comment">/* λx.x */</span>
          <span class="hljs-keyword">var</span> identity = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"x"</span>));
          expect(
            evaluateCPS(identity, emptyEnv, returns)
          ).to.a(
            <span class="hljs-string">'function'</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>(λx.x)(1) = 1 */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  	  <span class="hljs-keyword">var</span> appliedExpression = exp.application(identity, exp.number(<span class="hljs-number">1</span>));
	  	  expect(
            evaluateCPS(appliedExpression, emptyEnv, returns)
          ).to.eql(
            <span class="hljs-number">1</span>
          );
          next();
        });
        it(<span class="hljs-string">'ブール型を評価する'</span>, (next) =&gt; {
          <span class="hljs-keyword">this</span>.timeout(<span class="hljs-number">1000</span>);
          <span class="hljs-comment">/* λx.λy.x */</span>
          <span class="hljs-keyword">var</span> trueFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"x"</span>)));
          <span class="hljs-comment">/* λx.λy.y */</span>
          <span class="hljs-keyword">var</span> falseFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"y"</span>)));
          <span class="hljs-keyword">var</span> not = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.application(
                             exp.application(
                               exp.variable(<span class="hljs-string">"x"</span>),falseFun),
                             trueFun));
          <span class="hljs-keyword">var</span> and = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                  exp.application(
                                    exp.application(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"y"</span>)),
                                    falseFun)));
          <span class="hljs-keyword">var</span> or = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                          exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                 exp.application(
                                   exp.application(exp.variable(<span class="hljs-string">"x"</span>),trueFun),
                                   exp.variable(<span class="hljs-string">"y"</span>))));
          <span class="hljs-keyword">var</span> cond = exp.lambda(exp.variable(<span class="hljs-string">"pred"</span>),
                            exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                                   exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                          exp.application(
                                            exp.application(exp.variable(<span class="hljs-string">"pred"</span>),exp.variable(<span class="hljs-string">"x"</span>)),exp.variable(<span class="hljs-string">"y"</span>)))));</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(0) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          expect(
            evaluateCPS(
              exp.application(
                exp.application(trueFun,exp.number(<span class="hljs-number">1</span>)),
                exp.number(<span class="hljs-number">0</span>)),
              emptyEnv,
              returns)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(z) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          expect(
            evaluateCPS(
              exp.application(
                exp.application(trueFun,exp.number(<span class="hljs-number">1</span>)),
                exp.variable(<span class="hljs-string">"z"</span>)),
              emptyEnv,
              returns)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>(λx.λy.x)(z)(0) = error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          expect(
            evaluateCPS(
              exp.application(
                exp.application(trueFun,exp.variable(<span class="hljs-string">"z"</span>)),
                exp.number(<span class="hljs-number">0</span>)),
              emptyEnv,
              returns)
          ).to.eql(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"z not found"</span>)
          );
          next();
        });
        it(<span class="hljs-string">'raiseを使う'</span>, (next) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>(λx.raise)(2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> applied = exp.application(exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.raise(<span class="hljs-string">"exception"</span>)),
                                        exp.number(<span class="hljs-number">2</span>));
	  	  expect(
            evaluateCPS(applied, emptyEnv, returns)
          ).to.eql(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>)
          );
          next();
        });
      });
    });
    describe(<span class="hljs-string">'例外捕捉評価器'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="-">式の代数的データ構造</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-comment">/* #@range_begin(continuation_passing_interpreter_expression) */</span>
      <span class="hljs-keyword">var</span> exp = {
        exception: (message) =&gt; {
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.exception(message);
          };
        },
        raise: (exception) =&gt; {
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.raise(exception);
          };
        },
        tryWith: (exp, exception, raisedExp) =&gt; {
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.tryWith(exp, exception, raisedExp);
          };
        },
        <span class="hljs-comment">/* #@range_end(continuation_passing_interpreter_expression) */</span>
        number: (value) =&gt; {
          expect(value).to.a(<span class="hljs-string">'number'</span>);
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.number(value);
          };
        },
        variable: (name) =&gt; {
          expect(name).to.a(<span class="hljs-string">'string'</span>);
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.variable(name);
          };
        },
        lambda: (variable, body) =&gt; {
          expect(variable).to.a(<span class="hljs-string">'function'</span>);
          expect(body).to.a(<span class="hljs-string">'function'</span>);
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.lambda(variable, body);
          };
        },
        application: (variable, arg) =&gt; {
          <span class="hljs-keyword">return</span> (pattern) =&gt; {
            <span class="hljs-keyword">return</span> pattern.application(variable, arg);
          };
        }
      }; <span class="hljs-comment">// exp</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="-">式の評価関数</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-comment">/* #@range_begin(continuation_passing_interpreter_evaluate) */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>evaluateCPS: (EXP, ENV, FUNC[VALUE -&gt; VALUE]) -&gt; VALUE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> evaluateCPS = (exp, env, continues, continuesInFailure) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>c.f. Programming Language Concepts, p.208</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> match(exp,{
          <span class="hljs-comment">/* 例外の評価 */</span>
          raise: (exception) =&gt; {
            <span class="hljs-keyword">return</span> continuesInFailure(exception);
          },
          tryWith: (exp, caughtException, failSafeExp) =&gt; {
            <span class="hljs-keyword">var</span> newContinuesInFailure = (thrownException) =&gt; {
              <span class="hljs-keyword">if</span> (thrownException.message === caughtException.message) {
                <span class="hljs-keyword">return</span> evaluateCPS(failSafeExp, env, continues, continuesInFailure);
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> continuesInFailure(thrownException);
              }
            };
            <span class="hljs-keyword">return</span> evaluateCPS(exp, env, continues, newContinuesInFailure);
          },
          <span class="hljs-comment">/* 数値の評価 */</span>
          number: (answer) =&gt; {
            <span class="hljs-keyword">return</span> continues(answer);
          },
          <span class="hljs-comment">/* 変数の評価 */</span>
          variable: (name) =&gt; {
            <span class="hljs-keyword">var</span> found = lookupEnv(name, env);
            <span class="hljs-keyword">if</span>(found === <span class="hljs-literal">undefined</span>){
               <span class="hljs-keyword">return</span> continuesInFailure(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(name + <span class="hljs-string">" not found"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>return new Error(name + “ not found”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>             } <span class="hljs-keyword">else</span> {
               <span class="hljs-keyword">return</span> continues(found);
             }
          },
          <span class="hljs-comment">/* λ式の評価 */</span>
          lambda: (exp, bodyExp) =&gt; {
            <span class="hljs-comment">/* クロージャーを返す */</span>
            <span class="hljs-keyword">return</span> (actualArg) =&gt; {
              <span class="hljs-keyword">return</span> match(exp,{
                variable: (name) =&gt; {
                  <span class="hljs-keyword">return</span> continues(evaluateCPS(bodyExp, extendEnv(name, actualArg ,env), continues));
                },
                number: (value) =&gt; {
                  <span class="hljs-keyword">return</span> continuesInFailure(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数が数値になっています"</span>));
                },
                lambda: ($$,$$$) =&gt; {
                  <span class="hljs-keyword">return</span> continuesInFailure(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数がlambbaになっています"</span>));
                }
              });
            };
          },
          <span class="hljs-comment">/* 関数適用の評価 */</span>
          application: (exp, arg) =&gt; {
            <span class="hljs-keyword">var</span> rator = evaluateCPS(exp, env, continues, continuesInFailure);
            <span class="hljs-keyword">var</span> rand = evaluateCPS(arg, env, continues, continuesInFailure);
            <span class="hljs-keyword">return</span> continues(rator(rand));
          }
        });
        <span class="hljs-comment">/* #@range_end(continuation_passing_interpreter_evaluate) */</span>
      };
	  describe(<span class="hljs-string">'例外捕捉評価器をテストする'</span>, () =&gt; {
	  	<span class="hljs-keyword">var</span> continuesNormally = (result) =&gt; {
	  	  <span class="hljs-keyword">return</span> result;
	  	};
	  	<span class="hljs-keyword">var</span> continuesAbnormally = (exception) =&gt; {
          <span class="hljs-keyword">return</span> exception;
	  	};
        it(<span class="hljs-string">'数値を評価する'</span>, (next) =&gt; {
          expect(
            evaluateCPS(exp.number(<span class="hljs-number">2</span>), emptyEnv, continuesNormally, continuesAbnormally)
          ).to.eql(<span class="hljs-number">2</span>);
	  	  next();
        });
        it(<span class="hljs-string">'変数を評価する'</span>, (next) =&gt; {
          <span class="hljs-keyword">var</span> env = extendEnv(<span class="hljs-string">"x"</span>,<span class="hljs-number">1</span>, emptyEnv, continuesNormally, continuesAbnormally);
	  	  expect(
            evaluateCPS(exp.variable(<span class="hljs-string">"x"</span>), env, continuesNormally, continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>自由変数の場合は、 例外が返る</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  	  expect(
            evaluateCPS(exp.variable(<span class="hljs-string">"y"</span>), env, continuesNormally, continuesAbnormally)
          ).to.eql(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"y not found"</span>)
          );
          next();
        });
        it(<span class="hljs-string">'constant関数'</span>, (next) =&gt; {
          <span class="hljs-keyword">var</span> constant = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.number(<span class="hljs-number">1</span>));
          expect(
            evaluateCPS(constant, emptyEnv, continuesNormally, continuesAbnormally)
          ).to.a(
            <span class="hljs-string">'function'</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>(λx.1)(2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> applied = exp.application(constant, exp.number(<span class="hljs-number">2</span>));
	  	  expect(
            evaluateCPS(applied, emptyEnv, continuesNormally, continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );
          next();
        });
        it(<span class="hljs-string">'identity関数をテストする'</span>, (next) =&gt; {
          <span class="hljs-comment">/* λx.x */</span>
          <span class="hljs-keyword">var</span> identity = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"x"</span>));
          expect(
            evaluateCPS(identity, emptyEnv, continuesNormally, continuesAbnormally)
          ).to.a(
            <span class="hljs-string">'function'</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>(λx.x)(1) = 1 */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  	  <span class="hljs-keyword">var</span> appliedExpression = exp.application(identity, exp.number(<span class="hljs-number">1</span>));
	  	  expect(
            evaluateCPS(appliedExpression, emptyEnv, continuesNormally, continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );
          next();
        });
        it(<span class="hljs-string">'ブール型を評価する'</span>, (next) =&gt; {
          <span class="hljs-keyword">this</span>.timeout(<span class="hljs-number">1000</span>);
          <span class="hljs-comment">/* λx.λy.x */</span>
          <span class="hljs-keyword">var</span> trueFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"x"</span>)));
          <span class="hljs-comment">/* λx.λy.y */</span>
          <span class="hljs-keyword">var</span> falseFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"y"</span>)));
          <span class="hljs-keyword">var</span> not = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.application(
                             exp.application(
                               exp.variable(<span class="hljs-string">"x"</span>),falseFun),
                             trueFun));
          <span class="hljs-keyword">var</span> and = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                  exp.application(
                                    exp.application(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"y"</span>)),
                                    falseFun)));
          <span class="hljs-keyword">var</span> or = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                          exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                 exp.application(
                                   exp.application(exp.variable(<span class="hljs-string">"x"</span>),trueFun),
                                   exp.variable(<span class="hljs-string">"y"</span>))));
          <span class="hljs-keyword">var</span> cond = exp.lambda(exp.variable(<span class="hljs-string">"pred"</span>),
                            exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                                   exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                          exp.application(
                                            exp.application(exp.variable(<span class="hljs-string">"pred"</span>),exp.variable(<span class="hljs-string">"x"</span>)),exp.variable(<span class="hljs-string">"y"</span>)))));</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(0) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          expect(
            evaluateCPS(
              exp.application(
                exp.application(trueFun,exp.number(<span class="hljs-number">1</span>)),
                exp.number(<span class="hljs-number">0</span>)),
              emptyEnv,
              continuesNormally,
              continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(z) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          expect(
            evaluateCPS(
              exp.application(
                exp.application(trueFun,exp.number(<span class="hljs-number">1</span>)),
                exp.variable(<span class="hljs-string">"z"</span>)),
              emptyEnv,
              continuesNormally,
              continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>(λx.λy.x)(z)(0) = error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          expect(
            evaluateCPS(
              exp.application(
                exp.application(trueFun,exp.variable(<span class="hljs-string">"z"</span>)),
                exp.number(<span class="hljs-number">0</span>)),
              emptyEnv,
              continuesNormally, 
              continuesAbnormally)
          ).to.eql(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"z not found"</span>)
          );
          next();
        });
        it(<span class="hljs-string">'投げられた例外を捕捉する'</span>, (next) =&gt; {
          <span class="hljs-comment">/* #@range_begin(continuation_passing_interpreter_trycatch) */</span>
          <span class="hljs-keyword">var</span> tryExpression = exp.tryWith(
            exp.raise(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>)), <span class="hljs-comment">// exp</span>
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>), <span class="hljs-comment">// caughtException</span>
            exp.number(<span class="hljs-number">1</span>) <span class="hljs-comment">// failSafeExp</span>
          );
	  	  expect(
            evaluateCPS(tryExpression, emptyEnv, continuesNormally, continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>(λx.tryWith(raise, exception , 1))(0) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> catchException = exp.application(exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                                                   exp.tryWith(
                                                     exp.raise(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>)),
                                                     <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>),
                                                     exp.number(<span class="hljs-number">1</span>)
                                                   )),
                                        exp.number(<span class="hljs-number">0</span>));
	  	  expect(
            evaluateCPS(catchException, emptyEnv, continuesNormally, continuesAbnormally)
          ).to.eql(
            <span class="hljs-number">1</span>
          );
          <span class="hljs-comment">/* #@range_end(continuation_passing_interpreter_trycatch) */</span>
          next();
        });
      });
    });
  });
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
