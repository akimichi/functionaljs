<!DOCTYPE html>

<html>
<head>
  <title>interpreter.spec.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
  <script type="text/javascript" async
          src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!-- <script type="text/x-mathjax-config"> -->
  <!--   MathJax.Hub.Config({ -->
  <!--   tex2jax: { -->
  <!--       inlineMath: [ ['$','$'], ['\\(','\\)'] ], -->
  <!--       displayMath: [ ['$$','$$'], ["\\[","\\]"] ], -->
  <!--       processEscapes: true -->
  <!--   } -->
  <!--   }); -->
  <!-- </script> -->
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>interpreter.spec.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

<span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'expect.js'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="-">継続渡し評価器のサンプルコード</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="-">環境モジュール</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> env = {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>空の環境</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  empty: (variable) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  },
  <span class="hljs-comment">/* 変数名に対応する値を環境から取りだす */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>lookupEnv:: (STRING, ENV) =&gt; M[VALUE]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lookup: (identifier, environment) =&gt; {
    <span class="hljs-keyword">return</span> environment(identifier);
  },
  <span class="hljs-comment">/* 環境を拡張する */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>extendEnv:: (STRING, VALUE, ENV) =&gt; ENV </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  extend: (identifier, value, environment) =&gt; {
    expect(identifier).to.a(<span class="hljs-string">'string'</span>);
    <span class="hljs-keyword">return</span> (queryIdentifier) =&gt; {
      expect(queryIdentifier).to.a(<span class="hljs-string">'string'</span>);
      <span class="hljs-keyword">if</span>(identifier === queryIdentifier) {
        <span class="hljs-keyword">return</span> value;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> env.lookup(queryIdentifier, environment);
      }
    };
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="-">例外捕捉評価器</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>describe(<span class="hljs-string">'例外捕捉評価器'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>「環境」モジュール</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> env = {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>empty:: STRING =&gt; VALUE </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    empty: (variable) =&gt; {                        <span class="hljs-comment">// 空の環境を作る</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>lookup:: (STRING, ENV) =&gt; VALUE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lookup : (name, environment) =&gt; {       <span class="hljs-comment">// 変数名に対応する値を環境から取りだす</span>
      <span class="hljs-keyword">return</span> environment(name);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>extend:: (STRING, VALUE, ENV) =&gt; ENV </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    extend: (identifier, value, environment) =&gt; { <span class="hljs-comment">// 環境を拡張する</span>
      <span class="hljs-keyword">return</span> (queryIdentifier) =&gt; {
        <span class="hljs-keyword">if</span>(identifier === queryIdentifier) {
          <span class="hljs-keyword">return</span> value;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> env.lookup(queryIdentifier,environment);
        }
      };
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3 id="-">式の代数的データ構造</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/* #@range_begin(continuation_passing_interpreter_expression) */</span>
  <span class="hljs-keyword">var</span> exp = {
    match : (data, pattern) =&gt; {
      <span class="hljs-keyword">return</span> data.call(exp, pattern);
    },
    exception: (message) =&gt; {
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.exception(message);
      };
    },
    raise: (exception) =&gt; {
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.raise(exception);
      };
    },
    tryWith: (anExp, exception, raisedExp) =&gt; {
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.tryWith(anExp, exception, raisedExp);
      };
    },
    <span class="hljs-comment">/* #@range_end(continuation_passing_interpreter_expression) */</span>
    num: (value) =&gt; {
      expect(value).to.a(<span class="hljs-string">'number'</span>);
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.num(value);
      };
    },
    variable: (name) =&gt; {
      expect(name).to.a(<span class="hljs-string">'string'</span>);
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.variable(name);
      };
    },
    lambda: (variable, body) =&gt; {
      expect(variable).to.a(<span class="hljs-string">'function'</span>);
      expect(body).to.a(<span class="hljs-string">'function'</span>);
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.lambda(variable, body);
      };
    },
    app: (variable, arg) =&gt; {
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.app(variable, arg);
      };
    }
  }; <span class="hljs-comment">// exp</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3 id="-">例外捕捉評価器の評価関数</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/* #@range_begin(continuation_passing_interpreter_evaluate) */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>evaluateCPS: (EXP, ENV, FUNC[VALUE -&gt; VALUE]) -&gt; VALUE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> evaluateCPS = (anExp, environment, continues, continuesInFailure) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>c.f. Programming Language Concepts, p.208</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> exp.match(anExp,{
      <span class="hljs-comment">/* 例外の評価 */</span>
      raise: (exception) =&gt; {
        <span class="hljs-keyword">return</span> continuesInFailure(exception);
      },
      tryWith: (anExp, caughtException, failSafeExp) =&gt; {
        <span class="hljs-keyword">var</span> newContinuesInFailure = (thrownException) =&gt; {
          <span class="hljs-keyword">if</span> (thrownException.message === caughtException.message) {
            <span class="hljs-keyword">return</span> evaluateCPS(failSafeExp, environment, continues, continuesInFailure);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> continuesInFailure(thrownException);
          }
        };
        <span class="hljs-keyword">return</span> evaluateCPS(anExp, environment, continues, newContinuesInFailure);
      },
      <span class="hljs-comment">/* 数値の評価 */</span>
      num: (answer) =&gt; {
        <span class="hljs-keyword">return</span> continues(answer);
      },
      <span class="hljs-comment">/* 変数の評価 */</span>
      variable: (name) =&gt; {
        <span class="hljs-keyword">var</span> found = env.lookup(name, environment);
        <span class="hljs-keyword">if</span>(found === <span class="hljs-literal">undefined</span>){
          <span class="hljs-keyword">return</span> continuesInFailure(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(name + <span class="hljs-string">" not found"</span>));
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> continues(found);
        }
      },
      <span class="hljs-comment">/* λ式の評価 */</span>
      lambda: (anExp, bodyExp) =&gt; {
        <span class="hljs-comment">/* クロージャーを返す */</span>
        <span class="hljs-keyword">return</span> (actualArg) =&gt; {
          <span class="hljs-keyword">return</span> exp.match(anExp,{
            variable: (name) =&gt; {
              <span class="hljs-keyword">return</span> continues(evaluateCPS(bodyExp, env.extend(name, actualArg ,environment), continues));
            },
            num: (value) =&gt; {
              <span class="hljs-keyword">return</span> continuesInFailure(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数が数値になっています"</span>));
            },
            lambda: ($$,$$$) =&gt; {
              <span class="hljs-keyword">return</span> continuesInFailure(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数がlambbaになっています"</span>));
            }
          });
        };
      },
      <span class="hljs-comment">/* 関数適用の評価 */</span>
      app: (anExp, arg) =&gt; {
        <span class="hljs-keyword">var</span> rator = evaluateCPS(anExp, environment, continues, continuesInFailure);
        <span class="hljs-keyword">var</span> rand = evaluateCPS(arg, environment, continues, continuesInFailure);
        <span class="hljs-keyword">return</span> continues(rator(rand));
      }
    });
    <span class="hljs-comment">/* #@range_end(continuation_passing_interpreter_evaluate) */</span>
  };
  describe(<span class="hljs-string">'例外捕捉評価器をテストする'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>「環境」モジュール</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> env = {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>empty:: STRING =&gt; VALUE </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      empty: (variable) =&gt; {                        <span class="hljs-comment">// 空の環境を作る</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>lookup:: (STRING, ENV) =&gt; VALUE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      lookup : (name, environment) =&gt; {       <span class="hljs-comment">// 変数名に対応する値を環境から取りだす</span>
        <span class="hljs-keyword">return</span> environment(name);
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>extend:: (STRING, VALUE, ENV) =&gt; ENV </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      extend: (identifier, value, environment) =&gt; { <span class="hljs-comment">// 環境を拡張する</span>
        <span class="hljs-keyword">return</span> (queryIdentifier) =&gt; {
          <span class="hljs-keyword">if</span>(identifier === queryIdentifier) {
            <span class="hljs-keyword">return</span> value;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> env.lookup(queryIdentifier,environment);
          }
        };
      }
    };
    <span class="hljs-keyword">var</span> emptyEnv = env.empty;
    <span class="hljs-keyword">var</span> continuesNormally = (result) =&gt; {
      <span class="hljs-keyword">return</span> result;
    };
    <span class="hljs-keyword">var</span> continuesAbnormally = (exception) =&gt; {
      <span class="hljs-keyword">return</span> exception;
    };
    it(<span class="hljs-string">'数値を評価する'</span>, (next) =&gt; {
      expect(
        evaluateCPS(exp.num(<span class="hljs-number">2</span>), emptyEnv, continuesNormally, continuesAbnormally)
      ).to.eql(<span class="hljs-number">2</span>);
      next();
    });
    it(<span class="hljs-string">'変数を評価する'</span>, (next) =&gt; {
      <span class="hljs-keyword">var</span> newEnv = env.extend(<span class="hljs-string">"x"</span>,<span class="hljs-number">1</span>, emptyEnv, continuesNormally, continuesAbnormally);
      expect(
        evaluateCPS(exp.variable(<span class="hljs-string">"x"</span>), newEnv, continuesNormally, continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>自由変数の場合は、 例外が返る</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(exp.variable(<span class="hljs-string">"y"</span>), newEnv, continuesNormally, continuesAbnormally)
      ).to.eql(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"y not found"</span>)
      );
      next();
    });
    it(<span class="hljs-string">'constant関数'</span>, (next) =&gt; {
      <span class="hljs-keyword">var</span> constant = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.num(<span class="hljs-number">1</span>));
      expect(
        evaluateCPS(constant, emptyEnv, continuesNormally, continuesAbnormally)
      ).to.a(
        <span class="hljs-string">'function'</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>(λx.1)(2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> applied = exp.app(constant, exp.num(<span class="hljs-number">2</span>));
      expect(
        evaluateCPS(applied, emptyEnv, continuesNormally, continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );
      next();
    });
    it(<span class="hljs-string">'identity関数をテストする'</span>, (next) =&gt; {
      <span class="hljs-comment">/* λx.x */</span>
      <span class="hljs-keyword">var</span> identity = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"x"</span>));
      expect(
        evaluateCPS(identity, emptyEnv, continuesNormally, continuesAbnormally)
      ).to.a(
        <span class="hljs-string">'function'</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>(λx.x)(1) = 1 */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> appliedExpression = exp.app(identity, exp.num(<span class="hljs-number">1</span>));
      expect(
        evaluateCPS(appliedExpression, emptyEnv, continuesNormally, continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );
      next();
    });
    it(<span class="hljs-string">'ブール型を評価する'</span>, (next) =&gt; {
      <span class="hljs-keyword">this</span>.timeout(<span class="hljs-number">1000</span>);
      <span class="hljs-comment">/* λx.λy.x */</span>
      <span class="hljs-keyword">var</span> trueFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"x"</span>)));
      <span class="hljs-comment">/* λx.λy.y */</span>
      <span class="hljs-keyword">var</span> falseFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"y"</span>)));
      <span class="hljs-keyword">var</span> not = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.app(
                             exp.app(
                               exp.variable(<span class="hljs-string">"x"</span>),falseFun),
                             trueFun));
      <span class="hljs-keyword">var</span> and = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                      exp.app(
                                        exp.app(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"y"</span>)),
                                        falseFun)));
      <span class="hljs-keyword">var</span> or = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                          exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                     exp.app(
                                       exp.app(exp.variable(<span class="hljs-string">"x"</span>),trueFun),
                                       exp.variable(<span class="hljs-string">"y"</span>))));
      <span class="hljs-keyword">var</span> cond = exp.lambda(exp.variable(<span class="hljs-string">"pred"</span>),
                            exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                                       exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                                  exp.app(
                                                    exp.app(exp.variable(<span class="hljs-string">"pred"</span>),exp.variable(<span class="hljs-string">"x"</span>)),exp.variable(<span class="hljs-string">"y"</span>)))));</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(0) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(
          exp.app(
            exp.app(trueFun,exp.num(<span class="hljs-number">1</span>)),
            exp.num(<span class="hljs-number">0</span>)),
          emptyEnv,
          continuesNormally,
          continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(z) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(
          exp.app(
            exp.app(trueFun,exp.num(<span class="hljs-number">1</span>)),
            exp.variable(<span class="hljs-string">"z"</span>)),
          emptyEnv,
          continuesNormally,
          continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>(λx.λy.x)(z)(0) = error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(
          exp.app(
            exp.app(trueFun,exp.variable(<span class="hljs-string">"z"</span>)),
            exp.num(<span class="hljs-number">0</span>)),
          emptyEnv,
          continuesNormally, 
          continuesAbnormally)
      ).to.eql(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"z not found"</span>)
      );
      next();
    });
    it(<span class="hljs-string">'投げられた例外を捕捉する'</span>, (next) =&gt; {
      <span class="hljs-comment">/* #@range_begin(continuation_passing_interpreter_trycatch) */</span>
      <span class="hljs-keyword">var</span> tryExpression = exp.tryWith(
        exp.raise(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>)), <span class="hljs-comment">// exp</span>
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>), <span class="hljs-comment">// caughtException</span>
        exp.num(<span class="hljs-number">1</span>) <span class="hljs-comment">// failSafeExp</span>
      );
      expect(
        evaluateCPS(tryExpression, emptyEnv, continuesNormally, continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>(λx.tryWith(raise, exception , 1))(0) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> catchException = exp.app(exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                                              exp.tryWith(
                                                exp.raise(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>)),
                                                <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>),
                                                exp.num(<span class="hljs-number">1</span>)
                                              )),
                                   exp.num(<span class="hljs-number">0</span>));
      expect(
        evaluateCPS(catchException, emptyEnv, continuesNormally, continuesAbnormally)
      ).to.eql(
        <span class="hljs-number">1</span>
      );
      <span class="hljs-comment">/* #@range_end(continuation_passing_interpreter_trycatch) */</span>
      next();
    });
  });
});

describe(<span class="hljs-string">'継続渡し評価器'</span>, () =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="-">式の代数的データ構造</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> exp = {
    match : (data, pattern) =&gt; {
      <span class="hljs-keyword">return</span> data.call(exp, pattern);
    },
    raise: (exp) =&gt; {
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.raise(exp);
      };
    },
    number: (value) =&gt; {
      expect(value).to.a(<span class="hljs-string">'number'</span>);
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.number(value);
      };
    },
    variable: (name) =&gt; {
      expect(name).to.a(<span class="hljs-string">'string'</span>);
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.variable(name);
      };
    },
    lambda: (variable, body) =&gt; {
      expect(variable).to.a(<span class="hljs-string">'function'</span>);
      expect(body).to.a(<span class="hljs-string">'function'</span>);
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.lambda(variable, body);
      };
    },
    app: (variable, arg) =&gt; {
      <span class="hljs-keyword">return</span> (pattern) =&gt; {
        <span class="hljs-keyword">return</span> pattern.app(variable, arg);
      };
    }
  }; <span class="hljs-comment">// exp</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="-">式の評価関数</h2>
<p>evaluateCPS: (EXP, ENV, FUNC[VALUE -&gt; VALUE]) -&gt; VALUE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> evaluateCPS = (anExp, environment, continues) =&gt; {
    <span class="hljs-keyword">return</span> exp.match(anExp,{
      <span class="hljs-comment">/* 例外の評価 */</span>
      raise: (message) =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message);
      },
      <span class="hljs-comment">/* 数値の評価 */</span>
      number: (answer) =&gt; {
        <span class="hljs-keyword">return</span> continues(answer);
      },
      <span class="hljs-comment">/* 変数の評価 */</span>
      variable: (name) =&gt; {
        <span class="hljs-keyword">var</span> found = env.lookup(name, environment);
        <span class="hljs-keyword">if</span>(found === <span class="hljs-literal">undefined</span>){
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(name + <span class="hljs-string">" not found"</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> continues(found);
        }
      },
      <span class="hljs-comment">/* λ式の評価 */</span>
      lambda: (anExp, bodyExp) =&gt; {
        <span class="hljs-comment">/* クロージャーを返す */</span>
        <span class="hljs-keyword">return</span> (actualArg) =&gt; {
          <span class="hljs-keyword">return</span> exp.match(anExp,{
            variable: (name) =&gt; {
              <span class="hljs-keyword">return</span> continues(evaluateCPS(bodyExp, env.extend(name, actualArg ,environment), continues));
            },
            number: (value) =&gt; {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数が数値になっています"</span>);
            },
            lambda: ($$,$$$) =&gt; {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"lambdaの引数がlambbaになっています"</span>);
            }
          });
        };
      },
      <span class="hljs-comment">/* 関数適用の評価 */</span>
      app: (anExp, arg) =&gt; {
        <span class="hljs-keyword">var</span> rator = evaluateCPS(anExp, environment, continues);
        <span class="hljs-keyword">var</span> rand = evaluateCPS(arg, environment, continues);
        <span class="hljs-keyword">return</span> continues(rator(rand));
      }
    });
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="-">単体テスト</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>  describe(<span class="hljs-string">'継続渡し評価器をテストする'</span>, () =&gt; {
    <span class="hljs-keyword">var</span> returns = (result) =&gt; {
      <span class="hljs-keyword">return</span> result;
    };
    it(<span class="hljs-string">'数値を評価する'</span>, (next) =&gt; {
      expect(
        evaluateCPS(exp.number(<span class="hljs-number">2</span>), env.empty, returns)
      ).to.eql(<span class="hljs-number">2</span>);
      next();
    });
    it(<span class="hljs-string">'変数を評価する'</span>, (next) =&gt; {
      <span class="hljs-keyword">var</span> environment = env.extend(<span class="hljs-string">"x"</span>,<span class="hljs-number">1</span>, env.empty, returns);
      expect(
        evaluateCPS(exp.variable(<span class="hljs-string">"x"</span>), environment, returns)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>自由変数の場合は、 abortが返る</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(exp.variable(<span class="hljs-string">"y"</span>), environment, returns)
      ).to.eql(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"y not found"</span>)
      );
      next();
    });
    it(<span class="hljs-string">'constant関数'</span>, (next) =&gt; {
      <span class="hljs-keyword">var</span> constant = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.number(<span class="hljs-number">1</span>));
      expect(
        evaluateCPS(constant, env.empty, returns)
      ).to.a(
        <span class="hljs-string">'function'</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>(λx.1)(2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> applied = exp.app(constant, exp.number(<span class="hljs-number">2</span>));
      expect(
        evaluateCPS(applied, env.empty, returns)
      ).to.eql(
        <span class="hljs-number">1</span>
      );
      next();
    });
    it(<span class="hljs-string">'identity関数をテストする'</span>, (next) =&gt; {
      <span class="hljs-comment">/* λx.x */</span>
      <span class="hljs-keyword">var</span> identity = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"x"</span>));
      expect(
        evaluateCPS(identity, env.empty, returns)
      ).to.a(
        <span class="hljs-string">'function'</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>(λx.x)(1) = 1 */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> appliedExpression = exp.app(identity, exp.number(<span class="hljs-number">1</span>));
      expect(
        evaluateCPS(appliedExpression, env.empty, returns)
      ).to.eql(
        <span class="hljs-number">1</span>
      );
      next();
    });
    it(<span class="hljs-string">'ブール型を評価する'</span>, (next) =&gt; {
      <span class="hljs-keyword">this</span>.timeout(<span class="hljs-number">1000</span>);
      <span class="hljs-comment">/* λx.λy.x */</span>
      <span class="hljs-keyword">var</span> trueFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"x"</span>)));
      <span class="hljs-comment">/* λx.λy.y */</span>
      <span class="hljs-keyword">var</span> falseFun = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),exp.variable(<span class="hljs-string">"y"</span>)));
      <span class="hljs-keyword">var</span> not = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.app(
                             exp.app(
                               exp.variable(<span class="hljs-string">"x"</span>),falseFun),
                             trueFun));
      <span class="hljs-keyword">var</span> and = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                           exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                      exp.app(
                                        exp.app(exp.variable(<span class="hljs-string">"x"</span>),exp.variable(<span class="hljs-string">"y"</span>)),
                                        falseFun)));
      <span class="hljs-keyword">var</span> or = exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                          exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                     exp.app(
                                       exp.app(exp.variable(<span class="hljs-string">"x"</span>),trueFun),
                                       exp.variable(<span class="hljs-string">"y"</span>))));
      <span class="hljs-keyword">var</span> cond = exp.lambda(exp.variable(<span class="hljs-string">"pred"</span>),
                            exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),
                                       exp.lambda(exp.variable(<span class="hljs-string">"y"</span>),
                                                  exp.app(
                                                    exp.app(exp.variable(<span class="hljs-string">"pred"</span>),exp.variable(<span class="hljs-string">"x"</span>)),exp.variable(<span class="hljs-string">"y"</span>)))));</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(0) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(
          exp.app(
            exp.app(trueFun,exp.number(<span class="hljs-number">1</span>)),
            exp.number(<span class="hljs-number">0</span>)),
          env.empty,
          returns)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>(λx.λy.x)(1)(z) = 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(
          exp.app(
            exp.app(trueFun,exp.number(<span class="hljs-number">1</span>)),
            exp.variable(<span class="hljs-string">"z"</span>)),
          env.empty,
          returns)
      ).to.eql(
        <span class="hljs-number">1</span>
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>(λx.λy.x)(z)(0) = error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      expect(
        evaluateCPS(
          exp.app(
            exp.app(trueFun,exp.variable(<span class="hljs-string">"z"</span>)),
            exp.number(<span class="hljs-number">0</span>)),
          env.empty,
          returns)
      ).to.eql(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"z not found"</span>)
      );
      next();
    });
    it(<span class="hljs-string">'raiseを使う'</span>, (next) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>(λx.raise)(2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> applied = exp.app(exp.lambda(exp.variable(<span class="hljs-string">"x"</span>),exp.raise(<span class="hljs-string">"exception"</span>)),
                            exp.number(<span class="hljs-number">2</span>));
      expect(
        evaluateCPS(applied, env.empty, returns)
      ).to.eql(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"exception"</span>)
      );
      next();
    });
  });
});</pre></div></div>
            
        </li>
        
    </ul>
  <!-- <div id="footer">  目次に戻る。 </div> -->
  <!-- </div> -->
</body>
</html>
